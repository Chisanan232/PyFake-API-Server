name: Bot PR

on:
  # It would only run at any events which be triggered by bot, i.e., GitHub dependency bot, for guarantee that the
  # change doesn't affect anything of source code.
  push:
    branches:
      - "develop/ci-cd"

  pull_request_review:
    types:
      - submitted
    branches:
      - "master"

env:
#  PR_NUMBER: ${{ github.event.number }}
  PR_NUMBER: 189    # Just for testing
  PR_WAITING_TIME: 1800    # 60 seconds * 30 minutes
  PR_EXIST: 0

jobs:
  auto-merge-pr:
#    name: Run all tests and organize all test reports
    runs-on: ubuntu-latest
#    if: ${{ ( github.event.review.state == 'approved' ) && ( contains(github.event.pull_request.labels.*.name, 'dependencies') ) }}
    name: Auto-merge PR if it waits for long time
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Sleep for 30 minutes
#        run: sleep $PR_WAITING_TIME
        run: sleep 10    # Just for testing

      - name: Check whether the PR has been merged or not
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set +e
          gh pr list -l dependencies --search "$PR_NUMBER" | grep "$PR_NUMBER"
          pr_exist="$?"
          if [ "$pr_exist" == "1" ];
          then
              echo "PR has been merged. Stop this CI workflow."
              echo "PR_EXIST=$pr_exist" >> $GITHUB_OUTPUT
          fi
        shell: bash

      - name: Check CI status of the PR is successful without any error
        if: ${{ env.PR_EXIST == '0' }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set +e
          gh pr checks $PR_NUMBER --watch

      - name: Merge PR if it doesn't be merged
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: gh pr merge $PR_NUMBER --admin
